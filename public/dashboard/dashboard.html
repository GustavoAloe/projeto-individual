<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eSports | Dashboard</title>

    <link rel="stylesheet" href="./../css/dashboards.css" />
    <script src="../js/sessao.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <script src="https://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body onload=" enviarparadiv(), enviarPontuacao(), enviarJogosCategoria()">
    <div class="janela">
      <div class="menu-lateral">
        <div class="logoDash">
          <a href="../index.html"
            ><img
              src="../assets/icon/logo.png"
              alt=""
              style="width: 6vw; padding-left: 1%"
          /></a>
          <a href="../index.html"><h1>eSports</h1></a>
        </div>
        <p class="bem-vindo">Olá, <span id="b_usuario">usuário</span></p>
        <div class="botoes-menu">
          <a href="quiz.html"><button>Quiz</button></a>
          <a href="dashboard.html"
            ><button id="dashboard-bnt">Dashboard</button></a
          >
          <a href="mensagem.html"><button>Fórum</button></a>
        </div>
        <button onclick="limparSessao()" class="btn-sair">Sair</button>
      </div>

      <div class="conteudo">
        <div class="areaGraficos">
          <div class="boxGrafico">
            <div class="tituloGrafico">
              <span>Receita total do eSports e videogame nos últimos anos</span>
            </div>
            <div class="areaGrafico">
              <canvas id="myChart"></canvas>
            </div>
          </div>
          <br><br>
          <div class="boxGrafico">
            <div class="tituloGrafico">
              <span>Quantidade de pessoas em cada categoria</span>
            </div>
            <div class="areaGrafico">
              <canvas id="myChart2"></canvas>
            </div>
          </div>
        </div>

        <div class="areaKPI">
          <div class="boxDados maiorPontuacao">
            <h3>Sua Maior Pontuação</h3>
            <div class="conteudoKPI" id="conteudoMaiorPontuacao">
              <span id="maiorPontuacao">-</span>
            </div>
          </div>

          <div class="boxDados qtdJogos">
            <h3><span id="categoriaFavorita"></span></h3>
            <div class="conteudoKPI">
              <span id="qtdJogosCompetidos">-</span>
            </div>
          </div>
        </div>

        <div class="rankingPontuacao">
          <div>
            <span class="titleRanking" id="rankingUsuarios"
              ><ion-icon name="podium-outline"></ion-icon
            ></span>
            <span class="textRanking" id="rankingPontos"></span>
          </div>
        </div>
      </div>
    </div>

    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>

<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  const ctx1 = document.getElementById("myChart");

  new Chart(ctx1, {
    type: "bar",
    data: {
      labels: ["2017", "2018", "2019", "2020", "2021", "2022", "2023", "2024"],
      datasets: [
        {
          label: "Ganho em bilhões de $",
          data: ["121", "140", "162", "197", "215", "236", "267", "276"],
          borderWidht: 1,
          backgroundColor: ['rgb(0, 155, 45)']
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var categoria = [];
  var usuario = [];

    const ctx2 = document.getElementById('myChart2')

    fetch(`/dashboard/usuariosCategoria`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    }).then(function (resposta) {

        if (resposta.ok) {
            resposta.json().then((json) => {
                console.log(json)
                json.forEach(element => {
                    categoria.push(element.categoria)
                    usuario.push(element.qtdPessoas)
                });
            }).then(() => {
                carregarGrafico2()
            })
        } else if (resposta.status == 404) {
            window.alert("Deu 404!");
        }
    }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
    });

    function carregarGrafico2() {
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['FPS', 'MOBA', 'BATTLE ROYALE', 'FIGHTING GAME', 'CARD GAME', 'SIMULADORES', 'RTS'],
                datasets: [{
                    label: 'Votos',
                    data: [usuario[0], usuario[1], usuario[2], usuario[3], usuario[4], usuario[5], usuario[6], 0],
                    borderWidth: 1,
                    backgroundColor: [
                        'rgb(50, 50, 50)',
                        'rgb(70, 70, 70)',
                        'rgb(90, 90, 90)',
                        'rgb(110, 110, 110)',
                        'rgb(30, 30, 30)',
                        'rgb(20, 20, 20)',
                        'rgb(45, 45, 45)'
                    ],
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            },
            x: {
                stacked: true,
                maxBarThickness: 60 // Ajuste a largura máxima das barras
            }
        });
    }
  function enviarparadiv() {
    fetch("/quiz/listar_pontuacao")
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();
            plotarGrafico(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function enviarPontuacao() {
    let usuarioId = sessionStorage.getItem("ID_USUARIO");
    if (!usuarioId) {
      usuarioId = 0;
    }

    fetch(`/dashboard/exibirMaiorPontuacao?id=${usuarioId}`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            plotarPontuacao(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function enviarJogosCategoria() {
    let usuarioId = sessionStorage.getItem("ID_USUARIO");
    if (!usuarioId) {
      usuarioId = 0;
    }

    fetch(`/dashboard/enviarJogosCategoria?id=${usuarioId}`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            plotarJogosCategoria(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function plotarGrafico(resposta) {
    rankingUsuarios.innerHTML += `Ranking<br><br>`;
    for (let contador = 0; contador < resposta.length; contador++) {
      rankingPontos.innerHTML += `${contador + 1}º: ${
        resposta[contador].nome
      } <br>
    Pontuação: ${resposta[contador].pontuacao} <br><br>`;
    }
  }

  function plotarPontuacao(resposta) {
    if ( resposta[0].maiorPontuacao == null) {
      maiorPontuacao.innerHTML = '-'
    } else {
      maiorPontuacao.innerHTML = `${resposta[0].maiorPontuacao}`;
    }
  }

  function plotarJogosCategoria(resposta) {

    if (resposta.length > 0) {
      qtdJogosCompetidos.innerHTML = `${resposta[0].qtdJogos}`;
      categoriaFavorita.innerHTML = `${resposta[0].categoria} mais competidos`;
    } else {
      qtdJogosCompetidos.innerHTML = '0';
      categoriaFavorita.innerHTML = "Sem categoria";
    }
  }
</script>
