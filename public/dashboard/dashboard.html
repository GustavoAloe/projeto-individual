<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link
      rel="shortcut icon"
      href="../assets/icon/favicon2.ico"
      type="image/x-icon"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eSports | Dashboard</title>

    <link rel="stylesheet" href="./../css/dashboards.css" />
    <script src="../js/sessao.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <script src="https://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body onload=" enviarparadiv(), enviarPontuacao(), enviarJogosCategoria()">
    <div class="janela">
      <div class="menu-lateral">
        <div class="logoDash">
          <a href="../index.html"
            ><img
              src="../assets/icon/logo.png"
              alt=""
              style="width: 6vw; padding-left: 1%"
          /></a>
          <a href="../index.html"><h1>eSports</h1></a>
        </div>
        <p class="bem-vindo">Olá, <span id="b_usuario">usuário</span></p>
        <div class="botoes-menu">
          <a href="quiz.html"><button>Quiz</button></a>
          <a href="dashboard.html"
            ><button id="dashboard-bnt">Dashboard</button></a
          >
          <a href="mensagem.html"><button>Fórum</button></a>
        </div>
        <button onclick="limparSessao()" class="btn-sair">Sair</button>
      </div>

      <div class="conteudo">
        <div class="areaGraficos">
          <div class="boxGrafico">
            <div class="tituloGrafico">
              <span>Receita total do eSports e videogame nos últimos anos</span>
            </div>
            <div class="areaGrafico">
              <canvas id="myChart"></canvas>
            </div>
          </div>

          <div class="boxGrafico">
            <div class="tituloGrafico">
              <span>Quantidade de pessoas em cada categoria</span>
            </div>
            <div class="areaGrafico">
              <canvas id="myChart2"></canvas>
            </div>
          </div>
        </div>

        <div class="areaKPI">
          <div class="boxDados maiorPontuacao">
            <h3>Sua Maior Pontuação</h3>
            <div class="conteudoKPI" id="conteudoMaiorPontuacao">
              <span id="maiorPontuacao">-</span>
            </div>
          </div>

          <div class="boxDados qtdJogos">
            <h3><span id="categoriaFavorita"></span></h3>
            <div class="conteudoKPI">
              <span id="qtdJogosCompetidos">-</span>
            </div>
          </div>
        </div>

        <div class="rankingPontuacao">
          <div>
            <span class="titleRanking" id="rankingUsuarios"
              ><ion-icon name="podium-outline"></ion-icon
            ></span>
            <span class="textRanking" id="rankingPontos"></span>
          </div>
        </div>
      </div>
    </div>

    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>

<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  const ctx1 = document.getElementById("myChart");

  new Chart(ctx1, {
    type: "bar",
    data: {
      labels: ["2017", "2018", "2019", "2020", "2021", "2022", "2023", "2024"],
      datasets: [
        {
          label: "Ganho em bilhões de $",
          data: ["121", "140", "162", "197", "215", "236", "267", "276"],
          borderWidht: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  const ctx2 = document.getElementById("myChart2");

  new Chart(ctx2, {
    type: "bar",
    data: {
      labels: [
        "FPS",
        "MOBA",
        "BATTLE ROYALE",
        "CARD GAME",
        "FIGHTING GAME",
        "SIMULADORES",
        "RTS",
      ],
      datasets: [
        {
          label: "Usuários",
          data: [],
          borderWidht: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  function enviarparadiv() {
    fetch("/quiz/listar_pontuacao")
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();
            plotarGrafico(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function enviarPontuacao() {
    let usuarioId = sessionStorage.getItem("ID_USUARIO"); // Obter o ID do usuário
    if (!usuarioId) {
      usuarioId = 0; // Definir um valor padrão
    }

    fetch(`/dashboard/exibirMaiorPontuacao?id=${usuarioId}`) // Passar o ID na URL
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            plotarPontuacao(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function enviarJogosCategoria() {
    let usuarioId = sessionStorage.getItem("ID_USUARIO");
    if (!usuarioId) {
      usuarioId = 0;
    }

    fetch(`/dashboard/enviarJogosCategoria?id=${usuarioId}`)
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            plotarJogosCategoria(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function plotarGrafico(resposta) {
    rankingUsuarios.innerHTML += `Ranking<br><br>`;
    for (let contador = 0; contador < resposta.length; contador++) {
      rankingPontos.innerHTML += `${contador + 1}º: ${
        resposta[contador].nome
      } <br>
    Pontuação: ${resposta[contador].pontuacao} <br><br>`;
    }
  }

  function plotarPontuacao(resposta) {
    maiorPontuacao.innerHTML = `${resposta[0].maiorPontuacao}`;
  }

  function plotarJogosCategoria(resposta) {
    // Se a resposta tiver dados, mostrar a quantidade de jogos
    if (resposta.length > 0) {
      qtdJogosCompetidos.innerHTML = `${resposta[0].qtdJogos}`;
      categoriaFavorita.innerHTML = `${resposta[0].categoria} mais competidos`; // Mostrar a ca
    } else {
      qtdJogosCompetidos.innerHTML = "0"; // Mostrar 0 se não houver jogos
      categoriaFavorita.innerHTML = "Sem categoria"; // Mostrar mensagem se não houver categoria
    }
  }
</script>
